name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Set up environment variables for the entire job
    env:
      # Database connection
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      # Pinata API keys
      NEXT_PUBLIC_PINATA_API_KEY: ${{ secrets.NEXT_PUBLIC_PINATA_API_KEY }}
      NEXT_PUBLIC_PINATA_SECRET_API_KEY: ${{ secrets.NEXT_PUBLIC_PINATA_SECRET_API_KEY }}
      NEXT_PUBLIC_PINATA_JWT: ${{ secrets.NEXT_PUBLIC_PINATA_JWT }}
      # Auth
      NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Validate environment variables
        run: |
          echo "Checking required environment variables..."
          [ -z "$DATABASE_URL" ] && echo "⚠️ DATABASE_URL is not set" || echo "✅ DATABASE_URL is set"
          [ -z "$NEXT_PUBLIC_PINATA_API_KEY" ] && echo "⚠️ NEXT_PUBLIC_PINATA_API_KEY is not set" || echo "✅ NEXT_PUBLIC_PINATA_API_KEY is set"
          [ -z "$NEXT_PUBLIC_PINATA_SECRET_API_KEY" ] && echo "⚠️ NEXT_PUBLIC_PINATA_SECRET_API_KEY is not set" || echo "✅ NEXT_PUBLIC_PINATA_SECRET_API_KEY is set"
          [ -z "$NEXT_PUBLIC_PINATA_JWT" ] && echo "⚠️ NEXT_PUBLIC_PINATA_JWT is not set" || echo "✅ NEXT_PUBLIC_PINATA_JWT is set"
          [ -z "$NEXTAUTH_URL" ] && echo "⚠️ NEXTAUTH_URL is not set" || echo "✅ NEXTAUTH_URL is set"
          [ -z "$NEXTAUTH_SECRET" ] && echo "⚠️ NEXTAUTH_SECRET is not set" || echo "✅ NEXTAUTH_SECRET is set"

      - name: Lint
        run: npx eslint . --max-warnings 0 || true

      - name: Build
        run: pnpm run build

      - name: Test with coverage
        run: pnpm test:coverage

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: coverage/
          retention-days: 7
